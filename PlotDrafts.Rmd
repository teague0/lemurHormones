---
title:
output:
  html_document:
    keep_md: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      message = FALSE,
                      warning = FALSE)
```

## Ring-tailed lemur fecal glucocorticoids

Read in processed data

```{r}
library(tidyverse)
library(googlesheets4)

aggGC_full <- read_sheet("https://docs.google.com/spreadsheets/d/12EB2WXBiqfwHPIQ_2tqOvkV0i8Yzjoc5yhMlkAOtUv0/edit?usp=sharing")
```

## Targeted plots & analysis 
1. Seasonality of GC in adults:
    Do GC's change predictably with reproductive state in females (gestation, lactation, weaning, etc)
    
```{r}
library(gghalves)
library(lme4)
library(car)

aggGC_full %>% filter(!is.na(season), age.2wk > 150) %>% 
ggplot()+
  geom_half_boxplot(aes(x = season, y = log(mean.ngg), color = sex), side = "r")+
  geom_half_point(aes(x = season, y = log(mean.ngg), color = sex), side = "l", alpha = 0.6)+
  ggtitle("Fecal GC in RTL older than 150 weeks")+
  theme_bw()

aggGC_full.noNA <- aggGC_full %>% filter(!is.na(season))

adultSeason.lm <- lmer(log(mean.ngg)~season*sex + (1|an.id), data = aggGC_full.noNA[aggGC_full.noNA$age.2wk > 150, ])
Anova(adultSeason.lm)
summary(adultSeason.lm)

```

A mixed effects linear model shows only a signficant effect of sex on fecal GC's. Not of season, and there is no interaction between season & sex.

2. Aggression rates in adults across season & sex

```{r}

aggRc <- aggGC_full %>% filter(!is.na(season), age.2wk > 150) %>% 
ggplot()+
  geom_half_boxplot(aes(x = season, y = log(wkAggRcv.rt), color = sex), side = "r")+
  geom_half_point(aes(x = season, y = log(wkAggRcv.rt), color = sex), side = "l", alpha = 0.6)+
  theme_bw()+
  theme(legend.position = c(0.1, 0.85))

aggDt <- aggGC_full %>% filter(!is.na(season), age.2wk > 150) %>% 
ggplot()+
  geom_half_boxplot(aes(x = season, y = log(wkAggress.rt), color = sex), side = "r")+
  geom_half_point(aes(x = season, y = log(wkAggress.rt), color = sex), side = "l", alpha = 0.6)+
  theme_bw()+
    theme(legend.position = "none")

library(cowplot)
plot_grid(aggRc, aggDt, nrow = 2)

adultSeasonAggRc.lm <- lmer(wkAggRcv.rt~season*sex + (1|an.id), data = aggGC_full)
Anova(adultSeasonAggRc.lm)
summary(adultSeasonAggRc.lm)


```

3. Fecal GC ~ Age in weeks * sex

```{r}

agePlot <- aggGC_full %>% dplyr::filter(age.2wk <= 150) %>%
  ggplot()+
  geom_point(aes(x = age.2wk, y = log(mean.ngg), color = sex), alpha = 0.6)+
  geom_smooth(aes(x = age.2wk, y = log(mean.ngg), color = sex))+
  theme_bw()


bplot <- aggGC_full %>% dplyr::filter(age.2wk <= 150) %>%
  ggplot()+
  geom_half_boxplot(aes(x = ageClass, y = log(mean.ngg), color = sex), side = "r")+
  geom_half_point(aes(x = ageClass, y = log(mean.ngg), color = sex), side = "l", alpha = 0.6)+
  theme_bw()

plot_grid(agePlot, bplot, nrow = 2)

```


4. Aggression Received & Dealt ~ Age in weeks * sex

```{r}
aggPlot <- aggGC_full %>% dplyr::filter(age.2wk <= 150) %>%
  ggplot()+
  geom_point(aes(x = age.2wk, y = log(wkAggress.rt), color = sex), alpha = 0.6)+
  geom_smooth(aes(x = age.2wk, y = log(wkAggress.rt), color = sex))+
  theme_bw()

aggRcPlot <- aggGC_full %>% dplyr::filter(age.2wk <= 150) %>%
  ggplot()+
  geom_point(aes(x = age.2wk, y = log(wkAggRcv.rt), color = sex), alpha = 0.6)+
  geom_smooth(aes(x = age.2wk, y = log(wkAggRcv.rt), color = sex))+
  theme_bw()

bplot <- aggGC_full %>% dplyr::filter(age.2wk <= 150) %>%
  ggplot()+
  geom_half_boxplot(aes(x = ageClass, y = log(mean.ngg), color = sex), side = "r")+
  geom_half_point(aes(x = ageClass, y = log(mean.ngg), color = sex), side = "l", alpha = 0.6)+
  theme_bw()

plot_grid(aggPlot, aggRcPlot, nrow = 2)

```

### GAMM that includes individual ID.
We'll use a Generalized Additive Mixed Effects Model. A GAM is an extensions of a linear regression that can be used for curved data. Relationships between the individual predictors and the dependent variable follow smooth patterns that can be linear or nonlinear. We can estimate these smooth relationships simultaneously and then predict **g(E(Y)))** by simply adding them up.

When your model contains nonlinear effects, GAM provides a regularized and interpretable solution â€“ while other methods generally lack at least one of these three features. 

https://jacolienvanrij.com/Tutorials/GAMM.html#example-of-random-smooths

```{r}
library(mgcv)

#use only the animals that are less than 150 weeks

kids <- aggGC_full %>% filter(age.2wk <= 150)

m1 <- gamm(log(mean.ngg)~sex+s(age.2wk),
                     random = list(an.id=~1),
           correlation=corAR1(),
                     data = kids)
summary(m1$gam)
anova(m1$gam)
par(mfrow=c(2,2))
gam.check(m1$gam)

#Slightly more informative residual plots
fv <- exp(fitted(m1$lme)) ## predicted values (including re)
rsd <- (m1$gam$y - fv)/sqrt(fv) ## Pearson residuals (Poisson case)
op <- par(mfrow=c(1,2))
qqnorm(rsd);plot(fv^.5,rsd)
par(op)
```
The summary tells us that there is a significant effect of sex (p = 0.0063), and that fecal glucocorticoids change with age (F= 7.33, df = 6.671, p = 6.55e-07). This is what the `anova()` summary also tells us. Everything looks good in the diagnostic plots as well.

<br>

To plot the GAMM correctly, we need to create predicted data sets that account for the individual effects. 
```{r}
library(plyr)

#Create a data frame to hold the predicted data.
predDat <- ddply(kids, 
                 .(sex), 
                 summarize,
                 age.2wk = seq(min(age.2wk), max(age.2wk),length = 284))

#extract predicted values from the model & add them to the data frame
p1 <- predict(m1$gam, newdata = predDat, se = TRUE)
predDat$Fit <- p1$fit
predDat$SE  <- p1$se.fit

#Now plot it. 
ggplot()+
  geom_point(data = kids, 
             aes(x = age.2wk, 
                 y = log(mean.ngg), 
                 color = sex))+
  labs(x = "age (weeks)", y = expression(paste("fecal GC ln (ng ", g^-1, ")", sep = "")))+
  geom_line(data = predDat, 
            aes(x = age.2wk,
                y = Fit,
                color = sex))+
  geom_ribbon(data = predDat, 
                     aes(x = age.2wk, 
                         ymax = Fit + 1.96 * SE, 
                         ymin = Fit - 1.96 * SE,
                         fill = sex),
                     alpha = 0.5)+
  theme_bw()
  #facet_grid(.~sex, scales = "fixed")
                     
```

We can do the same thing for aggression dealt & received. This isn't working quite how I want it to yet and might need to be a zero inflated model or something.

```{r}
kids$an.id <- as.factor(kids$an.id)
kids$sex <- as.factor(kids$sex)

#I added 1 to the values. Otherwise it freaks out with the ln(0)
m2 <- gamm(log(wkAggress.rt+1)~sex+s(age.2wk, by = sex) + s(age.2wk, an.id, bs="fs", m=1),
           family = quasipoisson(link = "log"),
           random = list(an.id=~1),
           data = kids)
summary(m2$gam)
plot(m2$gam)
par(mfrow = c(2,2))
gam.check(m2$gam)

```
The model check on this looks terrible. Q-Q plot shows a lot of kurtosis (s-curve), and the histogram of the residuals is really skewed. May no log fit?


```{r}

#I added 1 to the values. Otherwise it freaks out with the ln(0)
m2a <- gamm(wkAggress.rt~sex+s(age.2wk),
                     random = list(an.id=~1),
                     data = kids)
summary(m2a$gam)
plot(m2a$gam)
par(mfrow = c(2,2))
gam.check(m2a$gam)

```



```{r}
#Create a data frame to hold the predicted data.
predDat <- ddply(kids, 
                 .(sex, an.id), 
                 summarize,
                 age.2wk = seq(min(age.2wk), max(age.2wk),length = 284))

#extract predicted values from the model & add them to the data frame
p1 <- predict(m2$gam, newdata = predDat, se = TRUE)
predDat$Fit <- p1$fit
predDat$SE  <- p1$se.fit

#Now plot it. 
ggplot()+
  geom_point(data = kids, 
             aes(x = age.2wk, 
                 y = log(wkAggress.rt+1), 
                 color = sex))+
  labs(x = "age (weeks)", y = expression(paste("weekly aggression rate", sep = "")))+
  geom_line(data = predDat, 
            aes(x = age.2wk,
                y = Fit,
                color = sex))+
  geom_ribbon(data = predDat, 
                     aes(x = age.2wk, 
                         ymax = Fit + 1.96 * SE, 
                         ymin = Fit - 1.96 * SE,
                         fill = sex),
                     alpha = 0.5)+
  theme_bw()

```

```{r}

#I added 1 to the values. Otherwise it freaks out with the ln(0)
m3 <- gamm(log(wkAggRcv.rt+1)~sex+s(age.2wk),
                     random = list(an.id=~1),
                     data = kids)
summary(m3$gam)
plot(m3$gam)

#Create a data frame to hold the predicted data.
predDat <- ddply(kids, 
                 .(sex), 
                 summarize,
                 age.2wk = seq(min(age.2wk), max(age.2wk),length = 284))

#extract predicted values from the model & add them to the data frame
p1 <- predict(m3$gam, newdata = predDat, se = TRUE)
predDat$Fit <- p1$fit
predDat$SE  <- p1$se.fit

#Now plot it. 
ggplot()+
  geom_point(data = kids, 
             aes(x = age.2wk, 
                 y = log(wkAggRcv.rt+1), 
                 color = sex))+
  labs(x = "age (weeks)", y = expression(paste("weekly aggression received rate", sep = "")))+
  geom_line(data = predDat, 
            aes(x = age.2wk,
                y = Fit,
                color = sex))+
  geom_ribbon(data = predDat, 
                     aes(x = age.2wk, 
                         ymax = Fit + 1.96 * SE, 
                         ymin = Fit - 1.96 * SE,
                         fill = sex),
                     alpha = 0.5)+
  theme_bw()

```